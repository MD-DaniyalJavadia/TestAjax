@{
    ViewData["Title"] = "Dashboard";
}
@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	<script src="~/js/chart-helper.js"></script>
	<script src="~/js/dashboards-analytics-graph.js"></script>
	<script src="~/js/dashboards-analytics-card.js"></script>
}
<div class="page-inner">
	<div class="container">
		<!-- First Row: 4 Cards -->
		<div class="row mb-3">
			<!-- Total Accounts -->
			<div class="col-sm-6 col-md-3">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-primary bubble-shadow-small">
									<i class="fas fa-users"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Total Accounts</p>
									<h4 class="card-title" id="partyCount"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Active Accounts -->
			<div class="col-sm-6 col-md-3">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-warning bubble-shadow-small">
									<i class="fas fa-user-check"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Active Accounts</p>
									<h4 class="card-title" id="activeAccounts"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Total Customers -->
			<div class="col-sm-6 col-md-3">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-info bubble-shadow-small">
									<i class="fas fa-user-tie"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Total Customers</p>
									<h4 class="card-title" id="totalCustomers"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Total Suppliers -->
			<div class="col-sm-6 col-md-3">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-secondary bubble-shadow-small">
									<i class="fas fa-industry"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Total Suppliers</p>
									<h4 class="card-title" id="totalSuppliers"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Second Row: 3 Cards -->
		<div class="row">
			<!-- Total Given -->
			<div class="col-sm-6 col-md-4">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-danger bubble-shadow-small">
									<i class="fas fa-arrow-up"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Total Given</p>
									<h4 class="card-title" id="totalgiven"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Total Received -->
			<div class="col-sm-6 col-md-4">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-success bubble-shadow-small">
									<i class="fas fa-coins"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Total Received</p>
									<h4 class="card-title" id="totalReceived"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Balance -->
			<div class="col-sm-6 col-md-4">
				<div class="card card-stats card-round">
					<div class="card-body ">
						<div class="row align-items-center">
							<div class="col-icon">
								<div class="icon-big text-center icon-dark bubble-shadow-small">
									<i class="fas fa-scale-balanced"></i>
								</div>
							</div>
							<div class="col col-stats ms-3 ms-sm-0">
								<div class="numbers">
									<p class="card-category">Balance</p>
									<h4 class="card-title" id="balanceamount"></h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>



	<div class="row">
		<div class="col-md-6">
			<div class="card card-round h-100">
				

				<div class="card-body">

					<!-- Nav tabs -->
					<ul class="nav nav-tabs" id="userStatsTab" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab" aria-controls="tab1" aria-selected="true">Monthly Payables</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab" aria-controls="tab2" aria-selected="false">Monthly Receivables</a>
						</li>
					</ul>

					<!-- Tab content -->
					<div class="tab-content mt-3" id="userStatsTabContent">
						<div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
							<div id="myChartLegend5"></div>
						</div>
						<div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
							<div id="myChartLegend4"></div>
						</div>
					</div>

				</div>

			</div>
		</div>
		<div class="col-md-6">
			<div class="card card-round h-100">
				<div class="card-header">
					<div class="card-head-row">
						<div class="card-title">Monthly Cash Flow</div>
					</div>
				</div>
				<div class="card-body">
					<div class="chart-container">
						<div id="myChartLegend3"></div>
					</div>
				</div>
			</div>
		</div>
			<div class="col-md-6 mt-5">
				<div class="card card-round">
				<div class="card-body">

					<!-- Nav tabs -->
					<ul class="nav nav-tabs" id="userStatsTab" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" id="tab3-tab" data-toggle="tab" href="#tab3" role="tab" aria-controls="tab3" aria-selected="true">
								Accounts Payable & Receivable Summary
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="tab6-tab" data-toggle="tab" href="#tab6" role="tab" aria-controls="tab6" aria-selected="false">
								Monthly Cash Flow
							</a>
						</li>
					</ul>

					<!-- Tab content -->
					<div class="tab-content mt-3" id="userStatsTabContent">
						<div class="tab-pane fade show active" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
							<div id="GroupChart1"></div>
						</div>
						<div class="tab-pane fade" id="tab6" role="tabpanel" aria-labelledby="tab6-tab">
							<div id="GroupChart6"></div>
						</div>
					</div>

				</div>

			</div>
		</div>


		<div class="col-md-6 mt-5">
			<div class="card card-round">
				<div class="card-body">

					<!-- Nav tabs -->
					<ul class="nav nav-tabs" id="userStatsTab" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" id="tab3-tab" data-toggle="tab" href="#tab3" role="tab" aria-controls="tab3" aria-selected="true">
								Accounts Payable & Receivable Summary
							</a>
						</li>
					</ul>

					<!-- Tab content -->
					<div class="tab-content mt-3" id="userStatsTabContent">
						<div class="tab-pane fade show active" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
							<div id="weekrevenueChart"></div>
						</div>
						
					</div>

				</div>

			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-4">
			<div class="card card-round">
				<div class="card-body">
					<div class="card-head-row card-tools-still-right">
						<div class="card-title">New Account</div>
					</div>
					<div class="card-list py-4" id="customerList">
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-8">
			<div class="card card-round">
				<div class="card-header">
					<div class="card-head-row card-tools-still-right">
						<div class="card-title">Transaction History</div>
					</div>
				</div>
				<div class="card-body p-0">
					<div class="table-responsive">
						<!-- Projects table -->
						<table class="table align-items-center mb-0">
							<thead class="thead-light">
								<tr>
									<th scope="col">Payment Number</th>
									<th scope="col" class="text-end">Date</th>
									<th scope="col" class="text-end">Amount</th>
									<th scope="col">Contact Type</th>
								</tr>
							</thead>
							<tbody id="transactionhistory">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<script>
	 $(document).ready(function () {

		 /* ================================
			TRANSACTION HISTORY
		 ================================= */
		 $.ajax({
			 url: '/Home/GetTransactions',
			 type: 'GET',
			 success: function (transactions) {

				 const tbody = $('#transactionhistory');
				 tbody.empty();

				 transactions.forEach(tx => {

					 const amount = tx.totalGiven || tx.totalReceived || 0;

					 // Badge Color Logic
					 let badgeClass = "bg-secondary";

					 if (tx.contactType === "Customer") {
						 badgeClass = "bg-primary";   // Blue
					 }
					 else if (tx.contactType === "Supplier") {
						 badgeClass = "bg-success";   // Green
					 }

					 const row = `
						 <tr>
							 <th scope="row">
								 <button class="btn btn-icon btn-round btn-success btn-sm me-2">
									 <i class="fa fa-check"></i>
								 </button>
								 ${tx.partyName ?? "-"}
							 </th>
							 <td class="text-end">${tx.monthName ?? ""} ${tx.year ?? ""}</td>
							 <td class="text-end">${amount.toFixed(2)}</td>
							 <td class="text-end">
								 <span class="badge ${badgeClass}">
									 ${tx.contactType ?? "-"}
								 </span>
							 </td>
						 </tr>
					 `;

					 tbody.append(row);
				 });
			 },
			 error: function (err) {
				 console.error("Error loading transactions:", err);
			 }
		 });


		 /* ================================
			NEW CUSTOMERS LIST
		 ================================= */
		 $.ajax({
			 url: '/Home/GetNewCustomers',
			 type: 'GET',
			 success: function (data) {

				 let html = '';

				 $.each(data, function (i, item) {

					 const firstLetter = item.name
						 ? item.name.charAt(0).toUpperCase()
						 : "?";

					 // Badge Color Logic
					 let badgeClass = "bg-secondary";

					 if (item.contactType === "Customer") {
						 badgeClass = "bg-primary";   // Blue
					 }
					 else if (item.contactType === "Supplier") {
						 badgeClass = "bg-success";   // Green
					 }

					 html += `
						 <div class="item-list d-flex align-items-center justify-content-between mb-2">

							 <div class="d-flex align-items-center">
								 <div class="avatar">
									 <span class="avatar-title rounded-circle border border-white bg-primary">
										 ${firstLetter}
									 </span>
								 </div>

								 <div class="info-user ms-3">
									 <div class="username">${item.name ?? "-"}</div>
								 </div>
							 </div>

							 <div>
								 <span class="badge ${badgeClass}"
									   style="font-size:13px; padding:6px 10px;">
									 ${item.contactType ?? "-"}
								 </span>
							 </div>

						 </div>
					 `;
				 });

				 $("#customerList").html(html);
			 },
			 error: function (err) {
				 console.error("Error loading customers:", err);
			 }
		 });

	 });
</script>
