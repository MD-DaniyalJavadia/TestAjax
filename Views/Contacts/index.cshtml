@{
    ViewData["Title"] = "Accounts";
    var activeTab = ViewData["ActiveTab"]?.ToString() ?? "customers";
}

<div class="page-inner">
    <!-- Header -->
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
        <div>
            <h3 class="fw-bold mb-3">Accounts</h3>
        </div>
        <div class="ms-md-auto py-2 py-md-0">
            <a href="#" class="btn btn-label-info btn-round me-2">View Report</a>
            <a asp-action="Create" class="btn btn-primary btn-round">
                <i class="fa fa-plus"></i> Add Contact
            </a>
        </div>
    </div>

    <div class="card card-round">
        <div class="card-body">
            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4" id="accountsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "customers" ? "active" : "")"
                            id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers"
                            type="button" role="tab">
                        Customers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "suppliers" ? "active" : "")"
                            id="suppliers-tab" data-bs-toggle="tab" data-bs-target="#suppliers"
                            type="button" role="tab">
                        Suppliers
                    </button>
                </li>
            </ul>

            <!-- Totals -->
            <div class="d-flex justify-content-center my-4">
                <div class="text-center mx-5">
                    <h5 class="text-success">I will give</h5>
                    <h3 class="text-success fw-bold" id="totalReceive">Rs. 0</h3>
                </div>
                <div class="text-center mx-5">
                    <h5 class="text-danger">I will receive</h5>
                    <h3 class="text-danger fw-bold" id="totalGive">Rs. 0</h3>
                </div>
            </div>

            <!-- DataTable -->
            <div class="table-responsive">
                <table class="table table-hover" id="accountsTable">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>NAME</th>
                            <th>NUMBER</th>
                            <th>DUE DATE</th>
                            <th>BALANCE</th>
                            <th class="text-center">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
            let table = $('#accountsTable').DataTable({
                responsive: true,
                autoWidth: false,
                ajax: {
                    url: '@Url.Action("GetContacts", "Contacts")',
                    data: function (d) {
                        let activeTab = $('#accountsTab .nav-link.active').attr('id');
                        d.type = activeTab === 'customers-tab' ? 'Customer' : 'Supplier';
                    },
                    dataSrc: 'data',
                    error: function (xhr, error, thrown) {
                        console.error('DataTables Ajax error:', xhr.status, xhr.responseText);
                        alert('Failed to load contacts. Check console for details.');
                    }
                },
                columns: [
                    { data: 'createdDateFormatted' },
                    { data: 'name' },
                    { data: 'phoneNumber', defaultContent: '-' },
                    { data: 'dueDate', defaultContent: '-' },
                    {
                        data: 'balance',
                        render: function (data) {
                            let val = parseFloat(data) || 0;
                            let color = val >= 0 ? 'text-success' : 'text-danger';
                            return `<span class="${color} fw-bold">Rs. ${Math.abs(val).toLocaleString('en-US')}</span>`;
                        }
                    },
                                  {
          data: 'contactId',   //  same name as controller
          orderable: false,
          render: function (id) {
            if (!id) return '-';

            return `
              <div class="text-center">
                <a href="/Ledger/Index/${id}" class="btn btn-sm btn-primary">
                  <i class="fas fa-eye"></i>
                </a>
              </div>`;
          }
        }
                ],
                order: [[0, 'desc']],
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    paginate: { previous: "Previous", next: "Next" }
                }
            });

            $('#accountsTab button[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
                table.ajax.reload();
                loadTotals();
            });

            loadTotals();
        });

        function loadTotals() {
            $.ajax({
                url: '@Url.Action("GetTotals", "Contacts")',
                type: 'GET',
                success: function (data) {
                    $('#totalReceive').text('Rs. ' + (data.formattedReceive || '0'));
                    $('#totalGive').text('Rs. ' + (data.formattedGive || '0'));
                },
                error: function (xhr) {
                    console.error('Totals failed:', xhr.status, xhr.responseText);
                }
            });
        }
    </script>
}